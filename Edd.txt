import streamlit as st
import pandas as pd
from custom_functions import extract_context  # Assuming extract_context is imported from custom_functions.py

# Initialize or load CSV to store results
csv_file = 'extracted_contexts.csv'

# Check if the CSV exists, otherwise create it
if not os.path.exists(csv_file):
    df = pd.DataFrame(columns=['pdf_name', 'keyword', 'context'])
    df.to_csv(csv_file, index=False)
else:
    df = pd.read_csv(csv_file)

st.title("ESG Document Analyzer for EDD Scoring")

# Step 1: Upload PDF file
uploaded_pdf = st.file_uploader("Upload a PDF", type=["pdf"])

if uploaded_pdf is not None:
    pdf_name = uploaded_pdf.name
    st.write(f"Uploaded file: {pdf_name}")

    # Step 2: Input keyword
    keyword = st.text_input("Enter the keyword to extract context")

    if keyword:
        # Step 3: Check if keyword already exists in the CSV for this PDF
        existing_entry = df[(df['pdf_name'] == pdf_name) & (df['keyword'].str.lower() == keyword.lower())]

        if not existing_entry.empty:
            # If found, return the context from the CSV
            context = existing_entry['context'].values[0]
            st.markdown("### Context from CSV (Previously Extracted):")  # Smaller header
            st.markdown(f"<div style='font-size:14px'>{context}</div>", unsafe_allow_html=True)
        else:
            # If not found, process the uploaded PDF in-memory
            context = extract_context(uploaded_pdf, keyword)

            # Display extracted context in standardized font size
            st.markdown("### Extracted Context:")  # Smaller header
            st.markdown(f"<div style='font-size:14px'>{context}</div>", unsafe_allow_html=True)

            # Create a new DataFrame with the new row
            new_row = pd.DataFrame({'pdf_name': [pdf_name], 'keyword': [keyword], 'context': [context]})

            # Concatenate the new row with the existing DataFrame
            df = pd.concat([df, new_row], ignore_index=True)

            # Save the updated DataFrame to the CSV
            df.to_csv(csv_file, index=False)

            st.success("Result saved to CSV.")
