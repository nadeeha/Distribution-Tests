import pandas as pd
import plotly.express as px
import plotly.io as pio

# Your ETF DataFrame
# df = pd.read_csv("your_data.csv")

themes = df["Theme"].dropna().unique()
html_sections = ""

for theme in themes:
    df_theme = df[df["Theme"] == theme].copy()
    section_html = f"<h1 style='text-align:center;'>{theme}</h1>"

    # 1. Weight Distribution
    fig1 = px.box(df_theme, x="weight", points="all", title=f"Weight Distribution - {theme}")
    section_html += pio.to_html(fig1, include_plotlyjs=False, full_html=False)

    # 2. L3 vs L6 ISIN Count
    l3_l6 = df_theme.groupby(["l3_name", "l6_name"])["ISIN"].nunique().reset_index(name="isin_count")
    fig2 = px.bar(l3_l6, x="isin_count", y="l3_name", color="l6_name", orientation="h",
                  title=f"L3 vs L6 ISIN Count - {theme}")
    section_html += pio.to_html(fig2, include_plotlyjs=False, full_html=False)

    # 3. GICS Sector ISIN Count
    gics = df_theme.groupby("gics_sector_name")["ISIN"].nunique().reset_index(name="isin_count")
    fig3 = px.bar(gics, x="gics_sector_name", y="isin_count", title=f"GICS Sector ISIN Count - {theme}")
    section_html += pio.to_html(fig3, include_plotlyjs=False, full_html=False)

    # 4. Market Cap by Sector
    fig4 = px.box(df_theme, x="gics_sector_name", y="market_cap",
                  title=f"Market Cap by Sector - {theme}")
    section_html += pio.to_html(fig4, include_plotlyjs=False, full_html=False)

    # 5. Sector Weight
    sector_weight = df_theme.groupby("gics_sector_name")["weight"].sum().reset_index()
    fig5 = px.bar(sector_weight, x="gics_sector_name", y="weight", title=f"Sector Weight - {theme}")
    section_html += pio.to_html(fig5, include_plotlyjs=False, full_html=False)

    # 6. Industry Weight
    industry_weight = df_theme.groupby("gics_industry_group_name")["weight"].sum().reset_index()
    fig6 = px.bar(industry_weight, x="gics_industry_group_name", y="weight",
                  title=f"Industry Weight - {theme}")
    section_html += pio.to_html(fig6, include_plotlyjs=False, full_html=False)

    html_sections += section_html

# Final HTML with header
full_html = f"""
<html>
<head>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <title>ETF Theme Analysis</title>
</head>
<body style='font-family:sans-serif;'>
    <h1 style='text-align:center;'>ETF Theme Analysis Dashboard</h1>
    {html_sections}
</body>
</html>
"""

# Save to file
with open("etf_theme_analysis.html", "w", encoding="utf-8") as f:
    f.write(full_html)
