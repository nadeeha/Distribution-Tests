import matplotlib.pyplot as plt
import seaborn as sns
import pandas as pd

def generate_plots_with_large_table(
    original_data, outlier_data, imputed_data, columns, folder_name, task
):
    """
    Generate clean plots with a larger table below the plots and highlight table headers.

    Args:
    - original_data: DataFrame before imputation.
    - outlier_data: DataFrame containing outlier values.
    - imputed_data: DataFrame after imputation.
    - columns: List of column names to process.
    - folder_name: Folder to save the plots.
    - task: Task name to include in plot titles.
    """
    for col in columns:
        # Inline function to generate a DataFrame for the table
        def generate_summary_df():
            # Example DataFrame generation logic
            data = {
                "Metric": ["Mean", "Median", "Std Dev"],
                "Value": [
                    original_data[col].mean(),
                    original_data[col].median(),
                    original_data[col].std(),
                ],
            }
            return pd.DataFrame(data)

        # Create a new figure with space for the table
        fig = plt.figure(figsize=(18, 28))
        grid = plt.GridSpec(5, 3, hspace=1.5, wspace=0.5)  # Adjust spacing for 5 rows

        # Plot 1: Histogram Before Imputation
        ax1 = fig.add_subplot(grid[0, 0])
        sns.histplot(original_data[col], kde=False, color="black", bins=20, ax=ax1)
        ax1.set_title(f"Histogram (Before {task}): {col}")
        ax1.set_xlabel(col)
        ax1.set_ylabel("Frequency")

        # Generate the DataFrame using the inline function
        summary_df = generate_summary_df()

        # Add the table below the plots
        ax_table = fig.add_subplot(grid[3:, :])
        ax_table.axis("off")  # Turn off the axis for the table

        # Display only the first 10 rows of the DataFrame for clarity
        table_data = summary_df.head(10)  # Adjust the row limit as needed
        table = ax_table.table(
            cellText=table_data.values,
            colLabels=table_data.columns,
            cellLoc="center",
            loc="center",
            bbox=[0.125, 0.2, 0.75, 0.6],  # Adjusts the position and width of the table
        )
        table.auto_set_font_size(False)
        table.set_fontsize(12)
        table.auto_set_column_width(col=list(range(len(table_data.columns))))

        # Highlight headers
        for (row, col), cell in table.get_celld().items():
            if row == 0:  # Header row
                cell.set_text_props(weight="bold", color="white")
                cell.set_facecolor("gray")

        # Save the figure
        plt.savefig(f"{folder_name}/{col}_plots_with_table.png")
        plt.close()
