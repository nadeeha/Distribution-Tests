import os
from openpyxl import load_workbook
from openpyxl.drawing.image import Image

# Step 1: Load the Excel file and access the "Outlier Details" sheet
excel_file_path = 'example.xlsx'  # Path to your Excel file
graphs_folder = 'Graphs'  # Path to the folder where graph images are stored
workbook = load_workbook(excel_file_path)
sheet = workbook['Outlier Details']  # Access the 'Outlier Details' sheet

# Step 2: Find the 'Column' column in the "Outlier Details" sheet
column_index = None
for col in sheet.iter_cols(1, sheet.max_column):
    if col[0].value == "Column":  # Locate the column named 'Column'
        column_index = col[0].column
        break

if column_index is None:
    raise ValueError("Column 'Column' not found in the 'Outlier Details' sheet.")

# Step 3: Add a new header for the 'Graph' column if it doesn't already exist
graph_column_index = sheet.max_column + 1
sheet.cell(row=1, column=graph_column_index, value='Graph')  # Add 'Graph' header

# Step 4: Loop through the rows of the 'Column' column, and insert the corresponding graph image
for row in range(2, sheet.max_row + 1):  # Start from row 2 to skip the header
    column_value = sheet.cell(row=row, column=column_index).value
    graph_image_path = os.path.join(graphs_folder, f'image_name_{column_value}.png')

    # Check if the corresponding graph image exists
    if os.path.exists(graph_image_path):
        # Load the image
        img = Image(graph_image_path)
        
        # Insert the image into the corresponding row of the new 'Graph' column
        cell_location = sheet.cell(row=row, column=graph_column_index).coordinate
        img.anchor = cell_location  # Anchor the image to a specific cell
        sheet.add_image(img)
    else:
        print(f"Graph image not found for column value {column_value}")

# Step 5: Save the modified Excel file
workbook.save(excel_file_path)
print("Graphs successfully inserted into the 'Outlier Details' sheet.")
